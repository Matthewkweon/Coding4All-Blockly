<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Python Editor with Side Console</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/python_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    #container { display: flex; }
    #leftPanel { flex: 2; display: flex; flex-direction: column; }
    #blocklyDiv { height: 480px; margin-bottom: 10px; }
    #buttons { display: flex; justify-content: space-between; margin-bottom: 10px; }
    #codeOutput { height: 150px; overflow-y: auto; background-color: #f0f0f0; border: 1px solid #ccc; padding: 10px; font-family: monospace; }
    #rightPanel { flex: 1; display: flex; flex-direction: column; margin-left: 20px; }
    #console { flex-grow: 1; overflow-y: auto; background-color: #f0f0f0; border: 1px solid #ccc; padding: 10px; font-family: monospace; }
    #loadingMessage { color: red; }
  </style>
</head>
<body>
  <div id="container">
    <div id="leftPanel">
      <div id="blocklyDiv"></div>
      <div id="buttons">
        <button onclick="generateCode()">Generate Python Code</button>
        <button onclick="runCode()" id="runButton" disabled>Run Code</button>
      </div>
      <pre id="codeOutput"></pre>
    </div>
    <div id="rightPanel">
      <h3>Console Output</h3>
      <div id="console"></div>
      <div id="loadingMessage">Loading Pyodide...</div>
    </div>
  </div>

  <script>
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: `
        <xml>
          <category name="Logic" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
          </category>
          <category name="Loops" colour="%{BKY_LOOPS_HUE}">
            <block type="controls_repeat_ext"></block>
            <block type="controls_whileUntil"></block>
          </category>
          <category name="Math" colour="%{BKY_MATH_HUE}">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
          </category>
          <category name="Text" colour="%{BKY_TEXTS_HUE}">
            <block type="text"></block>
            <block type="text_print"></block>
          </category>
        </xml>
      `
    });

    function generateCode() {
      var code = Blockly.Python.workspaceToCode(workspace);
      document.getElementById('codeOutput').textContent = code;
    }

    let pyodide;

    async function main() {
      try {
        pyodide = await loadPyodide();
        console.log("Pyodide loaded");
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('runButton').disabled = false;

        // Set up the Python environment
        pyodide.runPython(`
          import sys
          from js import document

          class WebConsole:
              def write(self, text):
                  element = document.getElementById('console')
                  element.innerHTML += text

          sys.stdout = WebConsole()
        `);
      } catch (error) {
        console.error("Failed to load Pyodide:", error);
        document.getElementById('loadingMessage').textContent = "Failed to load Pyodide. Please refresh the page and try again.";
      }
    }

    main();  // Start loading Pyodide immediately

    async function runCode() {
      const code = Blockly.Python.workspaceToCode(workspace);
      const consoleElement = document.getElementById('console');
      consoleElement.innerHTML = ''; // Clear previous output

      try {
        // Run the generated Python code
        await pyodide.runPythonAsync(code);
      } catch (error) {
        consoleElement.innerHTML += `<span style="color: red;">Error: ${error.message}</span>`;
      }
    }
  </script>
</body>
</html>