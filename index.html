<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Python Editor with Lists, Functions, and User Input</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/python_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    #container { display: flex; }
    #leftPanel { flex: 2; display: flex; flex-direction: column; }
    #blocklyDiv { height: 480px; margin-bottom: 10px; }
    #buttons { display: flex; justify-content: space-between; margin-bottom: 10px; }
    #codeOutput { height: 150px; overflow-y: auto; background-color: #f0f0f0; border: 1px solid #ccc; padding: 10px; font-family: monospace; }
    #rightPanel { flex: 1; display: flex; flex-direction: column; margin-left: 20px; }
    #console { flex-grow: 1; overflow-y: auto; background-color: #f0f0f0; border: 1px solid #ccc; padding: 10px; font-family: monospace; }
    #loadingMessage { color: red; }
  </style>
</head>
<body>
  <div id="container">
    <div id="leftPanel">
      <div id="blocklyDiv"></div>
      <div id="buttons">
        <button onclick="generateCode()">Generate Python Code</button>
        <button onclick="runCode()" id="runButton" disabled>Run Code</button>
      </div>
      <pre id="codeOutput"></pre>
    </div>
    <div id="rightPanel">
      <h3>Console Output</h3>
      <div id="console"></div>
      <div id="loadingMessage">Loading Pyodide...</div>
    </div>
  </div>

  <script>
    // Define the custom block using JSON
    Blockly.defineBlocksWithJsonArray([
      {
        "type": "user_input",
        "message0": "ask user %1",
        "args0": [
          {
            "type": "field_input",
            "name": "PROMPT",
            "text": "Enter something:"
          }
        ],
        "output": "String",
        "colour": 160,
        "tooltip": "Get input from the user",
        "helpUrl": ""
      }
    ]);

    // Define the Python generator for the custom block
    Blockly.Python['user_input'] = function(block) {
      var prompt = block.getFieldValue('PROMPT');
      var code = 'input("' + prompt + '")';
      return [code, Blockly.Python.ORDER_FUNCTION_CALL];
    };

    const toolbox = {
      kind: "categoryToolbox",
      contents: [
        {
          kind: "category",
          name: "Variables",
          custom: "VARIABLE",
          colour: "%{BKY_VARIABLES_HUE}"
        },
        {
          kind: "category",
          name: "Functions",
          custom: "PROCEDURE",
          colour: "%{BKY_PROCEDURES_HUE}"
        },
        {
          kind: "category",
          name: "Lists",
          colour: "%{BKY_LISTS_HUE}",
          contents: [
            { kind: "block", type: "lists_create_empty" },
            { kind: "block", type: "lists_create_with" },
            { kind: "block", type: "lists_repeat" },
            { kind: "block", type: "lists_length" },
            { kind: "block", type: "lists_isEmpty" },
            { kind: "block", type: "lists_indexOf" },
            { kind: "block", type: "lists_getIndex" },
            { kind: "block", type: "lists_setIndex" },
            { kind: "block", type: "lists_getSublist" },
            { kind: "block", type: "lists_sort" },
            { kind: "block", type: "lists_split" },
            { kind: "block", type: "lists_reverse" },
          ]
        },
        {
          kind: "category",
          name: "Logic",
          colour: "%{BKY_LOGIC_HUE}",
          contents: [
            { kind: "block", type: "controls_if" },
            { kind: "block", type: "logic_compare" },
            { kind: "block", type: "logic_operation" },
            { kind: "block", type: "logic_negate" },
            { kind: "block", type: "logic_boolean" }
          ]
        },
        {
          kind: "category",
          name: "Loops",
          colour: "%{BKY_LOOPS_HUE}",
          contents: [
            { kind: "block", type: "controls_repeat_ext" },
            { kind: "block", type: "controls_whileUntil" },
            { kind: "block", type: "controls_for" },
            { kind: "block", type: "controls_forEach" }
          ]
        },
        {
          kind: "category",
          name: "Math",
          colour: "%{BKY_MATH_HUE}",
          contents: [
            { kind: "block", type: "math_number" },
            { kind: "block", type: "math_arithmetic" },
            { kind: "block", type: "math_single" },
            { kind: "block", type: "math_trig" },
            { kind: "block", type: "math_constant" },
            { kind: "block", type: "math_number_property" },
            { kind: "block", type: "math_round" },
            { kind: "block", type: "math_on_list" },
            { kind: "block", type: "math_modulo" },
            { kind: "block", type: "math_constrain" },
            { kind: "block", type: "math_random_int" },
            { kind: "block", type: "math_random_float" }
          ]
        },
        {
          kind: "category",
          name: "Text",
          colour: "%{BKY_TEXTS_HUE}",
          contents: [
            { kind: "block", type: "text" },
            { kind: "block", type: "text_join" },
            { kind: "block", type: "text_append" },
            { kind: "block", type: "text_length" },
            { kind: "block", type: "text_isEmpty" },
            { kind: "block", type: "text_indexOf" },
            { kind: "block", type: "text_charAt" },
            { kind: "block", type: "text_getSubstring" },
            { kind: "block", type: "text_changeCase" },
            { kind: "block", type: "text_trim" },
            { kind: "block", type: "text_print" }
          ]
        },
        {
          kind: "category",
          name: "Input",
          colour: 160,
          contents: [
            { kind: "block", type: "user_input" }
          ]
        }
      ]
    };

    const workspace = Blockly.inject('blocklyDiv', { toolbox: toolbox });

    function generateCode() {
      var code = Blockly.Python.workspaceToCode(workspace);
      // Remove any remaining None initializations
      code = code.replace(/^(\w+) = None\n/gm, '');
      document.getElementById('codeOutput').textContent = code;
    }

    let pyodide;

    async function main() {
      try {
        pyodide = await loadPyodide();
        console.log("Pyodide loaded");
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('runButton').disabled = false;

        // Set up the Python environment
        pyodide.runPython(`
          import sys
          from js import document, prompt

          class WebConsole:
              def write(self, text):
                  element = document.getElementById('console')
                  element.innerHTML += text

          sys.stdout = WebConsole()

          def input(prompt_text):
              return prompt(prompt_text)
        `);
      } catch (error) {
        console.error("Failed to load Pyodide:", error);
        document.getElementById('loadingMessage').textContent = "Failed to load Pyodide. Please refresh the page and try again.";
      }
    }

    main();  // Start loading Pyodide immediately

    async function runCode() {
      const code = Blockly.Python.workspaceToCode(workspace);
      // Remove any remaining None initializations before running
      const cleanedCode = code.replace(/^(\w+) = None\n/gm, '');
      const consoleElement = document.getElementById('console');
      consoleElement.innerHTML = ''; // Clear previous output

      try {
        // Run the generated Python code
        await pyodide.runPythonAsync(cleanedCode);
      } catch (error) {
        consoleElement.innerHTML += `<span style="color: red;">Error: ${error.message}</span>`;
      }
    }
  </script>
</body>
</html>